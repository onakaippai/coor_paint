<!DOCTYPE html>
<html>
<style>
  .container
  {
  }
  .container textarea
  {
      vertical-align: top;
  }
  .container bottom
  {
      vertical-align: top;
  }
  .container canvas
  {
      vertical-align: top;
  }
</style>
<body>

<h1>
image setting
</h1>
<p>
  [image size]
  <label for="image_width">width:</label>
  <input type="text" id= "image_width" size="5" value="100">
  <label for="image_height">height:</label>
  <input type="text" id="image_height" size="5" value="100">
  &nbsp;&nbsp;&nbsp;
  [background]
  R:<input type="text" id="background_R" size="5" value="255">
  G:<input type="text" id="background_G" size="5" value="255">
  B:<input type="text" id="background_B" size="5" value="255">
  A:<input type="text" id="background_A" size="5" value="0">
</p>
<button onclick="generate()">generate</button>

<h1>
view setting
</h1>
<p>
  <label for="zoom">[zoom]</label>
  <input type="text" id= "zoom" size="5" value="100" onchange="view()">% &nbsp;&nbsp;&nbsp;  
  <label for="position_info">[position_info]</label>
  <select name="position_info" id="position_info" value="1" onchange="view()">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
</p>
    
<h1>
current svg code
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
view
</h1>
<div class=container>
<textarea id="current_code" name="current_code" rows="10" cols="40">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1">
</svg>
</textarea>
&nbsp;&nbsp;
<canvas id="view_canvas" width="100" height="100" style="border:1px solid #d3d3d3;">Your browser does not support the HTML5 canvas tag.</canvas>
<br><br>
<button onclick="view()">draw</button>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<button onclick="merge_code()">keep</button>
</div>


<p id="demo"></p>


<h1>
total svg code
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
final image
</h1>
<div class=container>
<textarea id="total_code" name="total_code" rows="10" cols="40">
</textarea>
&nbsp;&nbsp;
<canvas id="final_image" width="100" height="100" style="border:1px solid #d3d3d3;">Your browser does not support the HTML5 canvas tag.</canvas>
<br><br>
<button onclick="update_image()">update image</button>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<button onclick="save_code()">save code as txt</button>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<button onclick="save_image()">save image</button>
</div>

<script>
function drawInlineSVG(ctx, rawSVG, callback) {
    var svg = new Blob([rawSVG], {type:"image/svg+xml;charset=utf-8"}),
        domURL = self.URL || self.webkitURL || self,
        url = domURL.createObjectURL(svg),
        img = new Image;
	
    img.onload = function () {
        ctx.drawImage(this, 0, 0);     
        domURL.revokeObjectURL(url);
        callback(this);
    };
    img.src = url;
}

function view() { 
  var zoom           = document.getElementById("zoom").value;
  view_canvas.width  = final_image.width *zoom/100;
  view_canvas.height = final_image.height*zoom/100;
  var c   = document.getElementById("view_canvas");
  var ctx = c.getContext("2d");
  ctx.scale(zoom/100, zoom/100);  
  drawInlineSVG(ctx, document.getElementById("current_code").value, function(){});
  
  if (document.getElementById("position_info").value == 1){
    parser = new DOMParser();
    xmlDoc = parser.parseFromString(document.getElementById("current_code").value,"image/svg+xml");
    var path, command, type, info, x, y, i, j;
    var cmdRegEx = /([MLQTCSAZVH])([^MLQTCSAZVH]*)/gi;
    path = xmlDoc.getElementsByTagName('path');
    for (i = 0; i < path.length; i++) {
      command = path[i].getAttribute('d').match(cmdRegEx);
      for (j = 0; j < command.length; j++){
      	  type = command[j][0].toUpperCase()
          info = command[j].substring(1,command[j].length).split(/(?:,| )+/) ;
          switch(type){
              case 'A':
              break;
              case 'C':
              break;
              case 'H':
              case 'V':
              break;
              case 'L':
              case 'M':
              case 'T':
                  x = parseInt(info[0]);
                  y = parseInt(info[1]);
                  ctx.beginPath();
                  ctx.arc(x, y, 2*zoom/100, 0, 2 * Math.PI);
                  ctx.fillStyle = "red";
                  ctx.fill();
                  ctx.font = String(12*zoom/100)+"px Arial";
                  ctx.fillText("("+info[0]+","+info[1]+")", x-6*zoom/100, y-6*zoom/100);
                  ctx.fillStyle = "red";
                  ctx.fill();
              break;
              case 'Q':
              case 'S':
          }
      }
    }
  }
  
}

function generate() {
  var image_width  = document.getElementById( "image_width").value;
  var image_height = document.getElementById("image_height").value;
  var background_R = document.getElementById("background_R").value;
  var background_G = document.getElementById("background_G").value;
  var background_B = document.getElementById("background_B").value;
  var background_A = document.getElementById("background_A").value;  
  var zoom         = document.getElementById(        "zoom").value;
  
  final_image.width  = image_width;
  final_image.height = image_height;
  final_image.style.backgroundColor =
  'rgba('+background_R+","+background_G+","+background_B+","+background_A+")";;
  
  view_canvas.width  = image_width *zoom/100;
  view_canvas.height = image_height*zoom/100;
  view_canvas.style.backgroundColor =
  'rgba('+background_R+","+background_G+","+background_B+","+background_A+")";
  var c = document.getElementById("view_canvas");
  var ctx = c.getContext("2d");
  ctx.scale(zoom/100, zoom/100);

}
</script>
</body>
</html>
